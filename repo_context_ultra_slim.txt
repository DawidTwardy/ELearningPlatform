
==================================================
FILE: ELearning.Api\ELearning.Api\Controllers\AnalyticsController.cs
==================================================

using ELearning.Api.DTOs.Analytics;
using ELearning.Api.Persistence;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Security.Claims;

namespace ELearning.Api.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    [Authorize] // Zmiana: Usuni�to Roles = "Instructor,Admin", aby ka�dy tw�rca kursu mia� dost�p
    public class AnalyticsController : ControllerBase
    {
        private readonly ApplicationDbContext _context;

        public AnalyticsController(ApplicationDbContext context)
        {
            _context = context;
        }

        [HttpGet("course/{courseId}")]
        public async Task<ActionResult<CourseAnalyticsDto>> GetCourseStats(int courseId)
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);

            var course = await _context.Courses
                .FirstOrDefaultAsync(c => c.Id == courseId);

            if (course == null) return NotFound();

            // Weryfikacja: czy u�ytkownik jest w�a�cicielem kursu lub administratorem
            if (course.InstructorId != userId && !User.IsInRole("Admin")) return Forbid();

            var enrollments = await _context.Enrollments
                .Where(e => e.CourseId == courseId)
                .ToListAsync();

            var totalStudents = enrollments.Count;

            var quizAttempts = await _context.UserQuizAttempts
                .Include(a => a.Quiz)
                .ThenInclude(q => q.Section)
                .Where(a => a.Quiz.Section.CourseId == courseId)
                .ToListAsync();

            double avgQuizScore = 0;
            if (quizAttempts.Any())
            {
                avgQuizScore = quizAttempts.Average(a => a.Score);
            }

            var totalLessons = await _context.Lessons
                .CountAsync(l => l.Section.CourseId == courseId);

            double completionRate = 0;
            if (totalStudents > 0 && totalLessons > 0)
            {
                var totalCompletions = await _context.LessonCompletions
                    .Include(lc => lc.Lesson)
                    .ThenInclude(l => l.Section)
                    .CountAsync(lc => lc.Lesson.Section.CourseId == courseId);

                double totalPossibleCompletions = totalStudents * totalLessons;
                completionRate = (totalCompletions / totalPossibleCompletions) * 100;
            }

            var enrollmentGrowth = enrollments
                .GroupBy(e => e.EnrollmentDate.Date)
                .Select(g => new EnrollmentDataPoint
                {
                    Date = g.Key.ToString("yyyy-MM-dd"),
                    Count = g.Count()
                })
                .OrderBy(x => x.Date)
                .ToList();

            var result = new CourseAnalyticsDto
            {
                CourseId = course.Id,
                CourseTitle = course.Title,
                TotalStudents = totalStudents,
                AverageQuizScore = Math.Round(avgQuizScore, 2),
                CompletionRate = Math.Round(completionRate, 2),
                EnrollmentGrowth = enrollmentGrowth
            };

            return Ok(result);
        }
    }
}

==================================================
FILE: ELearning.Api\ELearning.Api\Controllers\AuthController.cs
==================================================

using ELearning.Api.DTOs.Auth;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.IdentityModel.Tokens;
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using System.Text;
using ELearning.Api.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace ELearning.Api.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class AuthController : ControllerBase
    {
        private readonly UserManager<ApplicationUser> _userManager;
        private readonly SignInManager<ApplicationUser> _signInManager;
        private readonly RoleManager<IdentityRole> _roleManager;
        private readonly IConfiguration _configuration;

        public AuthController(
            UserManager<ApplicationUser> userManager,
            SignInManager<ApplicationUser> signInManager,
            RoleManager<IdentityRole> roleManager,
            IConfiguration configuration)
        {
            _userManager = userManager;
            _signInManager = signInManager;
            _roleManager = roleManager;
            _configuration = configuration;
        }

        [HttpPost("register")]
        public async Task<IActionResult> Register([FromBody] RegisterDto model)
        {
            if (!ModelState.IsValid)
            {
                return BadRequest(ModelState);
            }

            var user = new ApplicationUser
            {
                UserName = model.Username,
                Email = model.Email,
                FirstName = model.FirstName,
                LastName = model.LastName
            };

            var result = await _userManager.CreateAsync(user, model.Password);

            if (result.Succeeded)
            {
                const string defaultRole = "User";

                if (!await _roleManager.RoleExistsAsync(defaultRole))
                {
                    await _roleManager.CreateAsync(new IdentityRole(defaultRole));
                }

                await _userManager.AddToRoleAsync(user, defaultRole);

                return Ok(new { Token = await GenerateJwtToken(user) });
            }

            return BadRequest(new
            {
                Errors = result.Errors.Select(e => new { Code = e.Code, Description = e.Description })
            });
        }

        [HttpPost("login")]
        public async Task<IActionResult> Login([FromBody] LoginDto model)
        {
            var user = await _userManager.FindByNameAsync(model.Username);

            if (user == null)
            {
                return Unauthorized(new { Message = "B��dny login lub has�o." });
            }

            var result = await _signInManager.CheckPasswordSignInAsync(user, model.Password, lockoutOnFailure: false);

            if (result.Succeeded)
            {
                return Ok(new { Token = await GenerateJwtToken(user) });
            }

            return Unauthorized(new { Message = "B��dny login lub has�o." });
        }

        private async Task<string> GenerateJwtToken(ApplicationUser user)
        {
            var claims = new List<Claim>
            {
                new Claim(ClaimTypes.NameIdentifier, user.Id),
                new Claim(ClaimTypes.Name, user.UserName!),
                new Claim(ClaimTypes.Email, user.Email!),
            };

            var roles = await _userManager.GetRolesAsync(user);
            foreach (var role in roles)
            {
                claims.Add(new Claim(ClaimTypes.Role, role));
            }

            var jwtSettings = _configuration.GetSection("JwtSettings");

            var jwtKey = jwtSettings["Secret"];
            if (string.IsNullOrEmpty(jwtKey))
            {
                throw new InvalidOperationException("JwtSettings:Secret not configured or is null.");
            }

            var key = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(jwtKey.Trim()));
            var creds = new SigningCredentials(key, SecurityAlgorithms.HmacSha256);

            var token = new JwtSecurityToken(
                issuer: jwtSettings["Issuer"],
                audience: jwtSettings["Audience"],
                claims: claims,
                expires: DateTime.Now.AddDays(7),
                signingCredentials: creds
            );

            return new JwtSecurityTokenHandler().WriteToken(token);
        }
    }
}

==================================================
FILE: ELearning.Api\ELearning.Api\Controllers\CertificatesController.cs
==================================================

using ELearning.Api.Persistence;
using ELearning.Api.Services;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Security.Claims;
using System.Threading.Tasks;

namespace ELearning.Api.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    [Authorize]
    public class CertificatesController : ControllerBase
    {
        private readonly ApplicationDbContext _context;
        private readonly CertificateService _certificateService;

        public CertificatesController(ApplicationDbContext context, CertificateService certificateService)
        {
            _context = context;
            _certificateService = certificateService;
        }

        [HttpGet("{courseId}")]
        public async Task<IActionResult> GetCertificate(int courseId)
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (string.IsNullOrEmpty(userId)) return Unauthorized();

            var enrollment = await _context.Enrollments
                .Include(e => e.Course)
                .ThenInclude(c => c.Instructor)
                .Include(e => e.User)
                .FirstOrDefaultAsync(e => e.CourseId == courseId && e.UserId == userId);

            if (enrollment == null)
            {
                return NotFound("Nie znaleziono zapisu na ten kurs.");
            }

            if (!enrollment.IsCompleted)
            {
                return BadRequest("Kurs nie zosta� jeszcze uko�czony.");
            }

            var studentName = $"{enrollment.User.FirstName} {enrollment.User.LastName}";
            if (string.IsNullOrWhiteSpace(studentName)) studentName = enrollment.User.UserName;

            var courseTitle = enrollment.Course.Title;
            var instructorName = enrollment.Course.Instructor != null
                ? enrollment.Course.Instructor.UserName
                : "Zesp� ELearning";

            var pdfBytes = _certificateService.GenerateCertificate(studentName, courseTitle, instructorName, DateTime.UtcNow);

            return File(pdfBytes, "application/pdf", $"Certyfikat_{courseTitle}_{userId}.pdf");
        }
    }
}

==================================================
FILE: ELearning.Api\ELearning.Api\Controllers\CommentsController.cs
==================================================

using ELearning.Api.DTOs.Discussion;
using ELearning.Api.Models;
using ELearning.Api.Models.CourseContent;
using ELearning.Api.Persistence;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Security.Claims;

namespace ELearning.Api.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    public class CommentsController : ControllerBase
    {
        private readonly ApplicationDbContext _context;

        public CommentsController(ApplicationDbContext context)
        {
            _context = context;
        }

        [HttpGet("course/{courseId}")]
        public async Task<ActionResult<IEnumerable<CommentDto>>> GetComments(int courseId)
        {
            var comments = await _context.Comments
                .Include(c => c.User)
                .Where(c => c.CourseId == courseId)
                .OrderByDescending(c => c.CreatedAt)
                .ToListAsync();

            var rootComments = comments.Where(c => c.ParentCommentId == null).ToList();
            var dtos = rootComments.Select(c => MapToDto(c, comments)).ToList();

            return Ok(dtos);
        }

        [HttpPost]
        [Authorize]
        public async Task<ActionResult<CommentDto>> CreateComment([FromBody] CreateCommentDto dto)
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);

            var comment = new Comment
            {
                CourseId = dto.CourseId,
                Content = dto.Content,
                ParentCommentId = dto.ParentCommentId,
                UserId = userId,
                CreatedAt = DateTime.UtcNow
            };

            _context.Comments.Add(comment);
            await _context.SaveChangesAsync();

            if (dto.ParentCommentId.HasValue)
            {
                var parentComment = await _context.Comments
                    .Include(c => c.User)
                    .FirstOrDefaultAsync(c => c.Id == dto.ParentCommentId.Value);

                if (parentComment != null && parentComment.UserId != userId)
                {
                    var notification = new Notification
                    {
                        UserId = parentComment.UserId,
                        Message = $"Kto� odpowiedzia� na Tw�j komentarz: \"{dto.Content}\"",
                        Type = "info",
                        CreatedAt = DateTime.UtcNow,
                        RelatedEntityId = dto.CourseId
                    };
                    _context.Notifications.Add(notification);
                    await _context.SaveChangesAsync();
                }
            }

            var createdComment = await _context.Comments
                .Include(c => c.User)
                .FirstOrDefaultAsync(c => c.Id == comment.Id);

            return Ok(MapToDto(createdComment, new List<Comment>()));
        }

        [HttpPut("{id}")]
        [Authorize]
        public async Task<IActionResult> UpdateComment(int id, [FromBody] UpdateCommentDto dto)
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            var comment = await _context.Comments.FindAsync(id);

            if (comment == null) return NotFound();
            if (comment.UserId != userId) return Forbid();

            comment.Content = dto.Content;
            await _context.SaveChangesAsync();

            return NoContent();
        }

        [HttpDelete("{id}")]
        [Authorize]
        public async Task<IActionResult> DeleteComment(int id)
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            var comment = await _context.Comments.Include(c => c.Replies).FirstOrDefaultAsync(c => c.Id == id);

            if (comment == null) return NotFound();
            if (comment.UserId != userId) return Forbid();

            await DeleteCommentRecursive(comment);
            await _context.SaveChangesAsync();

            return NoContent();
        }

        private async Task DeleteCommentRecursive(Comment comment)
        {
            var replies = await _context.Comments
                .Include(c => c.Replies)
                .Where(c => c.ParentCommentId == comment.Id)
                .ToListAsync();

            foreach (var reply in replies)
            {
                await DeleteCommentRecursive(reply);
            }
            _context.Comments.Remove(comment);
        }

        private CommentDto MapToDto(Comment comment, List<Comment> allComments)
        {
            var dto = new CommentDto
            {
                Id = comment.Id,
                UserId = comment.UserId,
                Author = comment.User?.UserName ?? "Nieznany",
                Avatar = "/src/icon/usericon.png",
                Text = comment.Content,
                CreatedAt = comment.CreatedAt
            };

            var replies = allComments.Where(c => c.ParentCommentId == comment.Id).OrderBy(c => c.CreatedAt).ToList();
            dto.Replies = replies.Select(r => MapToDto(r, allComments)).ToList();

            return dto;
        }
    }
}

==================================================
FILE: ELearning.Api\ELearning.Api\Controllers\CoursesController.cs
==================================================

﻿using ELearning.Api.Models;
using ELearning.Api.Models.CourseContent;
using ELearning.Api.Persistence;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Security.Claims;

namespace ELearning.Api.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    public class CoursesController : ControllerBase
    {
        private readonly ApplicationDbContext _context;

        public CoursesController(ApplicationDbContext context)
        {
            _context = context;
        }

        // GET: api/Courses (Publiczne - wszystkie kursy)
        [HttpGet]
        public async Task<ActionResult<IEnumerable<object>>> GetCourses()
        {
            var courses = await _context.Courses
                .Include(c => c.Instructor)
                .ToListAsync();

            var result = courses.Select(c => new
            {
                c.Id,
                c.Title,
                c.Description,
                c.Category,
                c.Level,
                c.Price,
                ImageSrc = c.ImageUrl,
                ImageUrl = c.ImageUrl,
                Rating = 0,
                Instructor = c.Instructor != null ? new { Name = c.Instructor.UserName, Bio = "Instruktor" } : null
            });

            return Ok(result);
        }

        // GET: api/Courses/my-courses (Prywatne - tylko kursy zalogowanego instruktora)
        [HttpGet("my-courses")]
        [Authorize]
        public async Task<ActionResult<IEnumerable<object>>> GetInstructorCourses()
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);

            if (string.IsNullOrEmpty(userId))
            {
                return Unauthorized("Nie rozpoznano użytkownika.");
            }

            // FILTROWANIE: Zwracamy tylko kursy, gdzie InstructorId == userId
            var courses = await _context.Courses
                .Where(c => c.InstructorId == userId)
                .Include(c => c.Instructor)
                .ToListAsync();

            var result = courses.Select(c => new
            {
                c.Id,
                c.Title,
                c.Description,
                c.Category,
                c.Level,
                c.Price,
                ImageSrc = c.ImageUrl,
                ImageUrl = c.ImageUrl,
                Rating = 0,
                Instructor = c.Instructor != null ? new { Name = c.Instructor.UserName, Bio = "Instruktor" } : null
            });

            return Ok(result);
        }

        [HttpGet("{id}")]
        public async Task<ActionResult<object>> GetCourse(int id)
        {
            var course = await _context.Courses
                .Include(c => c.Sections)
                .ThenInclude(s => s.Lessons)
                .Include(c => c.Sections)
                .ThenInclude(s => s.Quiz)
                .ThenInclude(q => q.Questions)
                .ThenInclude(qt => qt.Options)
                .Include(c => c.Instructor)
                .FirstOrDefaultAsync(c => c.Id == id);

            if (course == null)
            {
                return NotFound();
            }

            var result = new
            {
                course.Id,
                course.Title,
                course.Description,
                course.Category,
                course.Level,
                course.Price,
                ImageSrc = course.ImageUrl,
                ImageUrl = course.ImageUrl,
                Rating = 0,
                Instructor = course.Instructor != null ? new
                {
                    Name = course.Instructor.UserName,
                    AvatarSrc = "/src/icon/usericon.png",
                    Bio = "Instruktor"
                } : null,
                Sections = course.Sections.OrderBy(s => s.Order).Select(s => new
                {
                    s.Id,
                    s.Title,
                    s.Order,
                    Lessons = s.Lessons.Select(l => new
                    {
                        l.Id,
                        l.Title,
                        l.Content,
                        l.VideoUrl
                    }),
                    Quiz = s.Quiz != null ? new
                    {
                        s.Quiz.Id,
                        s.Quiz.Title,
                        Questions = s.Quiz.Questions.Select(q => new
                        {
                            q.Id,
                            q.Text,
                            q.QuestionType,
                            Options = q.Options.Select(o => new { o.Id, o.Text, o.IsCorrect })
                        })
                    } : null
                })
            };

            return Ok(result);
        }

        [HttpPost]
        [Authorize(Roles = "Instructor,Admin,User")]
        public async Task<ActionResult<object>> CreateCourse(Course course)
        {
            try
            {
                var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);

                if (string.IsNullOrEmpty(userId))
                {
                    return Unauthorized(new { title = "Nie udało się zidentyfikować użytkownika. Zaloguj się ponownie." });
                }

                course.InstructorId = userId;

                if (string.IsNullOrEmpty(course.ImageUrl))
                {
                    course.ImageUrl = "/src/course/placeholder_ai.png";
                }

                if (course.Sections == null) course.Sections = new List<CourseSection>();

                _context.Courses.Add(course);
                await _context.SaveChangesAsync();

                var result = new
                {
                    course.Id,
                    course.Title,
                    course.Description,
                    course.Category,
                    course.Level,
                    course.Price,
                    ImageSrc = course.ImageUrl,
                    ImageUrl = course.ImageUrl,
                    Rating = 0,
                    Instructor = new { Name = User.Identity?.Name ?? "Ja", Bio = "Instruktor" },
                    Sections = course.Sections.Select(s => new
                    {
                        s.Id,
                        s.Title,
                        s.Order,
                        Lessons = s.Lessons.Select(l => new
                        {
                            l.Id,
                            l.Title,
                            l.Content,
                            l.VideoUrl
                        }),
                        Quiz = s.Quiz != null ? new
                        {
                            s.Quiz.Id,
                            s.Quiz.Title
                        } : null
                    })
                };

                return StatusCode(201, result);
            }
            catch (Exception ex)
            {
                var innerMessage = ex.InnerException != null ? ex.InnerException.Message : "";
                return StatusCode(500, new { title = $"Błąd serwera: {ex.Message} {innerMessage}" });
            }
        }

        [HttpPut("{id}")]
        [Authorize(Roles = "Instructor,Admin,User")]
        public async Task<IActionResult> UpdateCourse(int id, [FromBody] Course course)
        {
            if (id != course.Id)
            {
                return BadRequest("ID kursu w URL nie zgadza się z ID w ciele żądania.");
            }

            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);

            var existingCourse = await _context.Courses
                .Include(c => c.Sections)
                    .ThenInclude(s => s.Lessons)
                .Include(c => c.Sections)
                    .ThenInclude(s => s.Quiz)
                        .ThenInclude(q => q.Questions)
                            .ThenInclude(qt => qt.Options)
                .FirstOrDefaultAsync(c => c.Id == id);

            if (existingCourse == null) return NotFound();

            if (existingCourse.InstructorId != userId && !User.IsInRole("Admin"))
            {
                return Forbid();
            }

            existingCourse.Title = course.Title;
            existingCourse.Description = course.Description;
            existingCourse.Category = course.Category;
            existingCourse.Level = course.Level;
            existingCourse.Price = course.Price;

            if (!string.IsNullOrEmpty(course.ImageUrl))
            {
                existingCourse.ImageUrl = course.ImageUrl;
            }

            bool hasNewContent = false;

            var incomingSectionIds = course.Sections.Where(s => s.Id > 0).Select(s => s.Id).ToList();
            var sectionsToDelete = existingCourse.Sections.Where(s => !incomingSectionIds.Contains(s.Id)).ToList();

            foreach (var sectionToDelete in sectionsToDelete)
            {
                _context.CourseSections.Remove(sectionToDelete);
            }

            foreach (var sectionDto in course.Sections)
            {
                if (sectionDto.Id > 0)
                {
                    var existingSection = existingCourse.Sections.FirstOrDefault(s => s.Id == sectionDto.Id);
                    if (existingSection != null)
                    {
                        existingSection.Title = sectionDto.Title;
                        existingSection.Order = sectionDto.Order;

                        var incomingLessonIds = sectionDto.Lessons.Where(l => l.Id > 0).Select(l => l.Id).ToList();
                        var lessonsToDelete = existingSection.Lessons.Where(l => !incomingLessonIds.Contains(l.Id)).ToList();

                        foreach (var l in lessonsToDelete) _context.Lessons.Remove(l);

                        foreach (var lessonDto in sectionDto.Lessons)
                        {
                            if (lessonDto.Id == 0)
                            {
                                hasNewContent = true;
                                existingSection.Lessons.Add(new Lesson
                                {
                                    Title = lessonDto.Title,
                                    Content = lessonDto.Content,
                                    VideoUrl = lessonDto.VideoUrl
                                });
                            }
                            else
                            {
                                var existingLesson = existingSection.Lessons.FirstOrDefault(l => l.Id == lessonDto.Id);
                                if (existingLesson != null)
                                {
                                    existingLesson.Title = lessonDto.Title;
                                    existingLesson.Content = lessonDto.Content;
                                    existingLesson.VideoUrl = lessonDto.VideoUrl;
                                }
                            }
                        }

                        if (sectionDto.Quiz != null)
                        {
                            if (existingSection.Quiz == null)
                            {
                                sectionDto.Quiz.Id = 0;
                                if (sectionDto.Quiz.Questions != null)
                                {
                                    foreach (var q in sectionDto.Quiz.Questions)
                                    {
                                        q.Id = 0;
                                        if (q.Options != null) foreach (var o in q.Options) o.Id = 0;
                                    }
                                }
                                existingSection.Quiz = sectionDto.Quiz;
                            }
                            else
                            {
                                existingSection.Quiz.Title = sectionDto.Quiz.Title;

                                var incomingQIds = sectionDto.Quiz.Questions.Where(q => q.Id > 0).Select(q => q.Id).ToList();
                                var questionsToDelete = existingSection.Quiz.Questions.Where(q => !incomingQIds.Contains(q.Id)).ToList();
                                foreach (var q in questionsToDelete) _context.Questions.Remove(q);

                                foreach (var qDto in sectionDto.Quiz.Questions)
                                {
                                    if (qDto.Id == 0)
                                    {
                                        if (qDto.Options != null) foreach (var o in qDto.Options) o.Id = 0;
                                        existingSection.Quiz.Questions.Add(qDto);
                                    }
                                    else
                                    {
                                        var existingQ = existingSection.Quiz.Questions.FirstOrDefault(q => q.Id == qDto.Id);
                                        if (existingQ != null)
                                        {
                                            existingQ.Text = qDto.Text;
                                            existingQ.QuestionType = qDto.QuestionType;

                                            var incomingOIds = qDto.Options.Where(o => o.Id > 0).Select(o => o.Id).ToList();
                                            var optionsToDelete = existingQ.Options.Where(o => !incomingOIds.Contains(o.Id)).ToList();
                                            foreach (var o in optionsToDelete) _context.AnswerOptions.Remove(o);

                                            foreach (var oDto in qDto.Options)
                                            {
                                                if (oDto.Id == 0) existingQ.Options.Add(oDto);
                                                else
                                                {
                                                    var existingO = existingQ.Options.FirstOrDefault(o => o.Id == oDto.Id);
                                                    if (existingO != null)
                                                    {
                                                        existingO.Text = oDto.Text;
                                                        existingO.IsCorrect = oDto.IsCorrect;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        else if (existingSection.Quiz != null)
                        {
                            _context.Quizzes.Remove(existingSection.Quiz);
                        }
                    }
                }
                else
                {
                    hasNewContent = true;
                    if (sectionDto.Lessons != null)
                    {
                        foreach (var l in sectionDto.Lessons) l.Id = 0;
                    }
                    if (sectionDto.Quiz != null)
                    {
                        sectionDto.Quiz.Id = 0;
                        if (sectionDto.Quiz.Questions != null)
                        {
                            foreach (var q in sectionDto.Quiz.Questions)
                            {
                                q.Id = 0;
                                if (q.Options != null) foreach (var o in q.Options) o.Id = 0;
                            }
                        }
                    }
                    existingCourse.Sections.Add(sectionDto);
                }
            }

            try
            {
                await _context.SaveChangesAsync();

                if (hasNewContent)
                {
                    var enrolledUserIds = await _context.Enrollments
                        .Where(e => e.CourseId == id)
                        .Select(e => e.UserId)
                        .ToListAsync();

                    if (enrolledUserIds.Any())
                    {
                        var notifications = enrolledUserIds.Select(uid => new Notification
                        {
                            UserId = uid,
                            Message = $"Nowa treść została dodana do kursu '{existingCourse.Title}'. Sprawdź co nowego!",
                            Type = "update",
                            CreatedAt = DateTime.UtcNow,
                            RelatedEntityId = id
                        }).ToList();

                        _context.Notifications.AddRange(notifications);
                        await _context.SaveChangesAsync();
                    }
                }
            }
            catch (DbUpdateConcurrencyException)
            {
                if (!CourseExists(id))
                {
                    return NotFound();
                }
                else
                {
                    throw;
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Błąd zapisu: {ex.Message}");
                if (ex.InnerException != null) Console.WriteLine($"Inner: {ex.InnerException.Message}");

                return StatusCode(500, new { title = $"Błąd podczas zapisu kursu: {ex.Message}" });
            }

            return NoContent();
        }

        [HttpDelete("{id}")]
        [Authorize(Roles = "Instructor,Admin,User")]
        public async Task<IActionResult> DeleteCourse(int id)
        {
            var course = await _context.Courses.FindAsync(id);
            if (course == null)
            {
                return NotFound();
            }

            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (course.InstructorId != userId && !User.IsInRole("Admin"))
            {
                return Forbid();
            }

            _context.Courses.Remove(course);
            await _context.SaveChangesAsync();

            return NoContent();
        }

        private bool CourseExists(int id)
        {
            return _context.Courses.Any(e => e.Id == id);
        }
    }
}

==================================================
FILE: ELearning.Api\ELearning.Api\Controllers\EnrollmentsController.cs
==================================================

using ELearning.Api.Models;
using ELearning.Api.Persistence;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Security.Claims;

namespace ELearning.Api.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    [Authorize]
    public class EnrollmentsController : ControllerBase
    {
        private readonly ApplicationDbContext _context;

        public EnrollmentsController(ApplicationDbContext context)
        {
            _context = context;
        }

        [HttpGet("check/{courseId}")]
        public async Task<ActionResult<bool>> CheckEnrollment(int courseId)
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (string.IsNullOrEmpty(userId)) return Ok(false);

            var exists = await _context.Enrollments
                .AnyAsync(e => e.UserId == userId && e.CourseId == courseId);

            return Ok(exists);
        }

        [HttpGet]
        public async Task<ActionResult<IEnumerable<object>>> GetMyEnrollments()
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);

            if (string.IsNullOrEmpty(userId))
            {
                return Unauthorized("Nie rozpoznano u�ytkownika.");
            }

            var enrollments = await _context.Enrollments
                .Include(e => e.Course)
                .ThenInclude(c => c.Instructor) // WA�NE: Pobieramy dane instruktora
                .Where(e => e.UserId == userId)
                .Select(e => new
                {
                    e.Id,
                    e.EnrollmentDate,
                    e.Progress,
                    Course = new
                    {
                        e.Course.Id,
                        e.Course.Title,
                        e.Course.Description,
                        e.Course.Price,
                        e.Course.Category,
                        e.Course.Level,
                        ImageUrl = !string.IsNullOrEmpty(e.Course.ImageUrl) ? e.Course.ImageUrl : "/src/course/placeholder_ai.png",
                        // Teraz Instructor nie b�dzie nullem, je�li jest przypisany w bazie
                        InstructorName = e.Course.Instructor != null ? e.Course.Instructor.UserName : "Instruktor"
                    }
                })
                .ToListAsync();

            return Ok(enrollments);
        }

        [HttpPost("{courseId}")]
        public async Task<IActionResult> Enroll(int courseId)
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);

            if (string.IsNullOrEmpty(userId))
            {
                return Unauthorized("Musisz by� zalogowany.");
            }

            var course = await _context.Courses.FindAsync(courseId);
            if (course == null)
            {
                return NotFound("Kurs nie istnieje.");
            }

            var existingEnrollment = await _context.Enrollments
                .FirstOrDefaultAsync(e => e.UserId == userId && e.CourseId == courseId);

            if (existingEnrollment != null)
            {
                
                return Ok(new { message = "Jeste� ju� zapisany na ten kurs.", enrollmentId = existingEnrollment.Id, alreadyEnrolled = true });
            }

            var enrollment = new Enrollment
            {
                UserId = userId,
                CourseId = courseId,
                EnrollmentDate = DateTime.UtcNow,
                Progress = 0,
                IsCompleted = false
            };

            _context.Enrollments.Add(enrollment);
            await _context.SaveChangesAsync();

            return Ok(new { message = "Zapisano na kurs pomy�lnie.", enrollmentId = enrollment.Id });
        }
    }
}

==================================================
FILE: ELearning.Api\ELearning.Api\Controllers\NotificationsController.cs
==================================================

using ELearning.Api.Persistence;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Security.Claims;

namespace ELearning.Api.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    [Authorize]
    public class NotificationsController : ControllerBase
    {
        private readonly ApplicationDbContext _context;

        public NotificationsController(ApplicationDbContext context)
        {
            _context = context;
        }

        [HttpGet]
        public async Task<ActionResult<IEnumerable<object>>> GetNotifications()
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);

            var notifications = await _context.Notifications
                .Where(n => n.UserId == userId)
                .OrderByDescending(n => n.CreatedAt)
                .ToListAsync();

            return Ok(notifications);
        }

        [HttpPut("{id}/read")]
        public async Task<IActionResult> MarkAsRead(int id)
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            var notification = await _context.Notifications.FindAsync(id);

            if (notification == null) return NotFound();
            if (notification.UserId != userId) return Forbid();

            notification.IsRead = true;
            await _context.SaveChangesAsync();

            return NoContent();
        }
    }
}

==================================================
FILE: ELearning.Api\ELearning.Api\Controllers\ProgressController.cs
==================================================

using ELearning.Api.Persistence;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Security.Claims;

namespace ELearning.Api.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    [Authorize]
    public class ProgressController : ControllerBase
    {
        private readonly ApplicationDbContext _context;

        public ProgressController(ApplicationDbContext context)
        {
            _context = context;
        }

        [HttpGet("course/{courseId}")]
        public async Task<ActionResult<decimal>> GetCourseProgress(int courseId)
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (userId == null) return Unauthorized();

            var enrollment = await _context.Enrollments
                .FirstOrDefaultAsync(e => e.CourseId == courseId && e.UserId == userId);

            if (enrollment == null) return NotFound("Nie jeste� zapisany na ten kurs.");

            var totalLessons = await _context.Lessons
                .Where(l => l.Section.CourseId == courseId)
                .CountAsync();

            var completedLessons = await _context.LessonCompletions
                .Include(lc => lc.Lesson)
                .ThenInclude(l => l.Section)
                .Where(lc => lc.UserId == userId && lc.Lesson.Section.CourseId == courseId)
                .CountAsync();

            int currentProgress = 0;
            if (totalLessons > 0)
            {
                currentProgress = (int)((double)completedLessons / totalLessons * 100);
            }

            if (enrollment.Progress != currentProgress)
            {
                enrollment.Progress = currentProgress;
                if (currentProgress == 100)
                {
                    enrollment.IsCompleted = true;
                }
                else
                {
                    enrollment.IsCompleted = false;
                }
                await _context.SaveChangesAsync();
            }

            return Ok(currentProgress);
        }

        [HttpGet("course/{courseId}/completed-lessons")]
        public async Task<ActionResult<IEnumerable<int>>> GetCompletedLessons(int courseId)
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (userId == null) return Unauthorized();

            var completedLessonIds = await _context.LessonCompletions
                .Include(lc => lc.Lesson)
                .ThenInclude(l => l.Section)
                .Where(lc => lc.UserId == userId && lc.Lesson.Section.CourseId == courseId)
                .Select(lc => lc.LessonId)
                .ToListAsync();

            return Ok(completedLessonIds);
        }

        [HttpGet("course/{courseId}/completed-quizzes")]
        public async Task<ActionResult<IEnumerable<int>>> GetCompletedQuizzes(int courseId)
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (userId == null) return Unauthorized();

            var passedQuizIds = await _context.UserQuizAttempts
                .Include(qa => qa.Quiz)
                .ThenInclude(q => q.Section)
                .Where(qa => qa.UserId == userId && qa.Quiz.Section.CourseId == courseId && qa.IsPassed)
                .Select(qa => qa.QuizId)
                .Distinct()
                .ToListAsync();

            return Ok(passedQuizIds);
        }

        [HttpPost("lesson/{lessonId}/complete")]
        public async Task<IActionResult> MarkLessonAsCompleted(int lessonId)
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (userId == null) return Unauthorized();

            var lesson = await _context.Lessons
                .Include(l => l.Section)
                .ThenInclude(s => s.Course)
                .FirstOrDefaultAsync(l => l.Id == lessonId);

            if (lesson == null) return NotFound("Lekcja nie istnieje.");

            var existingCompletion = await _context.LessonCompletions
                .FirstOrDefaultAsync(lc => lc.LessonId == lessonId && lc.UserId == userId);

            if (existingCompletion != null) return Ok(new { message = "Lekcja ju� uko�czona" });

            var completion = new Models.LessonCompletion
            {
                LessonId = lessonId,
                UserId = userId,
                CompletedAt = DateTime.UtcNow
            };

            _context.LessonCompletions.Add(completion);
            await _context.SaveChangesAsync();

            await UpdateEnrollmentProgress(userId, lesson.Section.Course.Id);

            return Ok(new { success = true });
        }

        [HttpGet("lesson/{lessonId}/completion")]
        public async Task<ActionResult<bool>> CheckLessonCompletion(int lessonId)
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (userId == null) return Ok(false);

            var isCompleted = await _context.LessonCompletions
                .AnyAsync(lc => lc.LessonId == lessonId && lc.UserId == userId);

            return Ok(isCompleted);
        }

        private async Task UpdateEnrollmentProgress(string userId, int courseId)
        {
            var enrollment = await _context.Enrollments
                .FirstOrDefaultAsync(e => e.UserId == userId && e.CourseId == courseId);

            if (enrollment == null) return;

            var totalLessons = await _context.Lessons
                .Where(l => l.Section.CourseId == courseId)
                .CountAsync();

            if (totalLessons == 0) return;

            var completedLessons = await _context.LessonCompletions
                .Include(lc => lc.Lesson)
                .ThenInclude(l => l.Section)
                .Where(lc => lc.UserId == userId && lc.Lesson.Section.CourseId == courseId)
                .CountAsync();

            int progressPercentage = (int)((double)completedLessons / totalLessons * 100);

            enrollment.Progress = progressPercentage;
            if (progressPercentage == 100)
            {
                enrollment.IsCompleted = true;
            }
            else
            {
                enrollment.IsCompleted = false;
            }

            await _context.SaveChangesAsync();
        }
    }
}

==================================================
FILE: ELearning.Api\ELearning.Api\Controllers\QuizzesController.cs
==================================================

using ELearning.Api.DTOs.Quiz;
using ELearning.Api.Interfaces;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using System.Security.Claims;
using System.Threading.Tasks;

namespace ELearning.Api.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    [Authorize]
    public class QuizzesController : ControllerBase
    {
        private readonly IQuizService _quizService;

        public QuizzesController(IQuizService quizService)
        {
            _quizService = quizService;
        }

        private string GetUserId() => User.FindFirstValue(ClaimTypes.NameIdentifier);

        // GET /api/quizzes/5
        [HttpGet("{id}")]
        public async Task<IActionResult> GetQuiz(int id)
        {
            var quiz = await _quizService.GetQuizByIdAsync(id, GetUserId());

            if (quiz == null)
            {
                return NotFound();
            }

            return Ok(quiz);
        }

        // POST /api/quizzes/submit
        [HttpPost("submit")]
        public async Task<IActionResult> SubmitQuiz([FromBody] SubmitQuizDto submitDto)
        {
            if (!ModelState.IsValid)
            {
                return BadRequest(ModelState);
            }

            var result = await _quizService.SubmitQuizAsync(submitDto, GetUserId());

            return Ok(result);
        }
    }
}

==================================================
FILE: ELearning.Api\ELearning.Api\Controllers\UploadController.cs
==================================================

using ELearning.Api.Services;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using System;
using System.Threading.Tasks;

namespace ELearning.Api.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    [Authorize]
    public class UploadController : ControllerBase
    {
        private readonly FileStorageService _fileStorageService;

        public UploadController(FileStorageService fileStorageService)
        {
            _fileStorageService = fileStorageService;
        }

        [HttpPost]
        [RequestSizeLimit(209715200)] // Zwi�kszamy limit dla tej metody do 200 MB
        public async Task<IActionResult> UploadFile(IFormFile file)
        {
            try
            {
                var allowedExtensions = new[] { ".pdf", ".mp4", ".avi", ".mov", ".png", ".jpg", ".jpeg" };
                // Sprawdzenie nulla przed dost�pem do FileName
                if (file == null || file.Length == 0)
                {
                    return BadRequest("Nie przes�ano pliku.");
                }

                var extension = System.IO.Path.GetExtension(file.FileName).ToLower();

                if (Array.IndexOf(allowedExtensions, extension) < 0)
                {
                    return BadRequest("Niedozwolony format pliku.");
                }

                string fileUrl = await _fileStorageService.SaveFileAsync(file);

                return Ok(new { url = fileUrl });
            }
            catch (Exception ex)
            {
                // Poprawiono liter�wk� w s�owie "B��d"
                return StatusCode(500, $"B��d serwera: {ex.Message}");
            }
        }
    }
}

==================================================
FILE: ELearning.Api\ELearning.Api\Data\ApplicationDbContext.cs
==================================================

﻿using ELearning.Api.Models;
using Microsoft.EntityFrameworkCore;
using Microsoft.AspNetCore.Identity.EntityFrameworkCore;
using ELearning.Api.Models.CourseContent;

namespace ELearning.Api.Persistence
{
    public class ApplicationDbContext : IdentityDbContext<ApplicationUser>
    {
        public ApplicationDbContext(DbContextOptions<ApplicationDbContext> options) : base(options)
        {
        }

        public DbSet<Course> Courses { get; set; }
        public DbSet<CourseSection> CourseSections { get; set; }
        public DbSet<Lesson> Lessons { get; set; }
        public DbSet<Quiz> Quizzes { get; set; }
        public DbSet<Question> Questions { get; set; }
        public DbSet<AnswerOption> AnswerOptions { get; set; }
        public DbSet<Enrollment> Enrollments { get; set; }
        public DbSet<LessonCompletion> LessonCompletions { get; set; }
        public DbSet<UserQuizAttempt> UserQuizAttempts { get; set; }
        public DbSet<UserAnswer> UserAnswers { get; set; }
        public DbSet<Comment> Comments { get; set; }
        public DbSet<Notification> Notifications { get; set; }

        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            base.OnModelCreating(modelBuilder);

            modelBuilder.Entity<Quiz>()
                .HasOne(q => q.Section)
                .WithOne(s => s.Quiz)
                .HasForeignKey<Quiz>(q => q.SectionId);

            modelBuilder.Entity<Question>()
                .HasOne(q => q.Quiz)
                .WithMany(qz => qz.Questions)
                .HasForeignKey(q => q.QuizId);

            modelBuilder.Entity<AnswerOption>()
                .HasOne(a => a.Question)
                .WithMany(q => q.Options)
                .HasForeignKey(a => a.QuestionId);

            modelBuilder.Entity<UserQuizAttempt>()
                .HasOne(a => a.Quiz)
                .WithMany()
                .HasForeignKey(a => a.QuizId);

            modelBuilder.Entity<UserQuizAttempt>()
                .HasOne(a => a.User)
                .WithMany()
                .HasForeignKey(a => a.UserId);

            modelBuilder.Entity<UserAnswer>()
                .HasOne(ua => ua.Attempt)
                .WithMany(a => a.UserAnswers)
                .HasForeignKey(ua => ua.AttemptId);

            modelBuilder.Entity<UserAnswer>()
                .HasOne(ua => ua.Question)
                .WithMany()
                .HasForeignKey(ua => ua.QuestionId);

            modelBuilder.Entity<UserAnswer>()
                .HasOne(ua => ua.AnswerOption)
                .WithMany()
                .HasForeignKey(ua => ua.AnswerOptionId);

            modelBuilder.Entity<Comment>()
                .HasOne(c => c.ParentComment)
                .WithMany(c => c.Replies)
                .HasForeignKey(c => c.ParentCommentId)
                .OnDelete(DeleteBehavior.Restrict);
        }
    }
}

==================================================
FILE: ELearning.Api\ELearning.Api\DTOs\Analytics\CourseAnalyticsDto.cs
==================================================

using System;
using System.Collections.Generic;

namespace ELearning.Api.DTOs.Analytics
{
    public class CourseAnalyticsDto
    {
        public int CourseId { get; set; }
        public string CourseTitle { get; set; }
        public int TotalStudents { get; set; }
        public double AverageQuizScore { get; set; }
        public double CompletionRate { get; set; }
        public List<EnrollmentDataPoint> EnrollmentGrowth { get; set; }
    }

    public class EnrollmentDataPoint
    {
        public string Date { get; set; }
        public int Count { get; set; }
    }
}

==================================================
FILE: ELearning.Api\ELearning.Api\DTOs\Auth\LoginDto.cs
==================================================

namespace ELearning.Api.DTOs.Auth
{
    public class LoginDto
    {
        public string Username { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
    }
}

==================================================
FILE: ELearning.Api\ELearning.Api\DTOs\Auth\RegisterDto.cs
==================================================

namespace ELearning.Api.DTOs.Auth
{
    public class RegisterDto
    {
        public string Username { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
        public string FirstName { get; set; } = string.Empty;
        public string LastName { get; set; } = string.Empty;
    }
}

==================================================
FILE: ELearning.Api\ELearning.Api\DTOs\Discussion\CommentDto.cs
==================================================

using System;
using System.Collections.Generic;

namespace ELearning.Api.DTOs.Discussion
{
    public class CommentDto
    {
        public int Id { get; set; }
        public string UserId { get; set; }
        public string Author { get; set; }
        public string Avatar { get; set; }
        public string Text { get; set; }
        public DateTime CreatedAt { get; set; }
        public List<CommentDto> Replies { get; set; } = new List<CommentDto>();
    }

    public class CreateCommentDto
    {
        public int CourseId { get; set; }
        public string Content { get; set; }
        public int? ParentCommentId { get; set; }
    }

    public class UpdateCommentDto
    {
        public string Content { get; set; }
    }
}

==================================================
FILE: ELearning.Api\ELearning.Api\DTOs\Quiz\AnswerOptionDto.cs
==================================================

namespace ELearning.Api.DTOs.Quiz
{
    public class AnswerOptionDto
    {
        public int AnswerOptionId { get; set; }
        public string Text { get; set; }
    }
}

==================================================
FILE: ELearning.Api\ELearning.Api\DTOs\Quiz\QuestionDto.cs
==================================================

using System.Collections.Generic;

namespace ELearning.Api.DTOs.Quiz
{
    public class QuestionDto
    {
        public int QuestionId { get; set; }
        public string Text { get; set; }
        public string QuestionType { get; set; }
        public ICollection<AnswerOptionDto> Options { get; set; } = new List<AnswerOptionDto>();
    }
}

==================================================
FILE: ELearning.Api\ELearning.Api\DTOs\Quiz\QuizQuestionsDto.cs
==================================================

using System.Collections.Generic;

namespace ELearning.Api.DTOs.Quiz
{
    public class QuizQuestionsDto
    {
        public int QuizId { get; set; }
        public string Title { get; set; }
        public int SectionId { get; set; }
        public ICollection<QuestionDto> Questions { get; set; } = new List<QuestionDto>();
    }
}

==================================================
FILE: ELearning.Api\ELearning.Api\DTOs\Quiz\QuizResultDto.cs
==================================================

namespace ELearning.Api.DTOs.Quiz
{
    public class QuizResultDto
    {
        public int Score { get; set; }
        public int MaxScore { get; set; }
        public bool IsPassed { get; set; }
        public int AttemptsCount { get; set; }
    }
}

==================================================
FILE: ELearning.Api\ELearning.Api\DTOs\Quiz\SubmitQuizDto.cs
==================================================

using System.Collections.Generic;

// Upewnij si�, �e ten namespace jest POPRAWNY
namespace ELearning.Api.DTOs.Quiz
{
    public class SubmitQuizDto
    {
        public int QuizId { get; set; }
        public ICollection<SubmittedAnswerDto> Answers { get; set; } = new List<SubmittedAnswerDto>();
    }
}

==================================================
FILE: ELearning.Api\ELearning.Api\DTOs\Quiz\SubmittedAnswerDto.cs
==================================================

namespace ELearning.Api.DTOs.Quiz
{
    public class SubmittedAnswerDto
    {
        public int QuestionId { get; set; }
        public int AnswerOptionId { get; set; }
    }
}

==================================================
FILE: ELearning.Api\ELearning.Api\Interfaces\IQuizService.cs
==================================================

using ELearning.Api.DTOs.Quiz;
using System.Threading.Tasks;

namespace ELearning.Api.Interfaces
{
    public interface IQuizService
    {
        Task<QuizQuestionsDto?> GetQuizByIdAsync(int quizId, string userId);
        Task<QuizResultDto> SubmitQuizAsync(SubmitQuizDto submitDto, string userId);
    }
}

==================================================
FILE: ELearning.Api\ELearning.Api\Models\ApplicationUser.cs
==================================================

using Microsoft.AspNetCore.Identity;

public class ApplicationUser : IdentityUser
{
    public string FirstName { get; set; } = string.Empty;
    public string LastName { get; set; } = string.Empty;
}

==================================================
FILE: ELearning.Api\ELearning.Api\Models\Course.cs
==================================================

﻿using System.Collections.Generic;
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;
using ELearning.Api.Models.CourseContent;

namespace ELearning.Api.Models
{
    public class Course
    {
        [Key]
        public int Id { get; set; }

        [Required]
        public string Title { get; set; } = string.Empty;

        public string Description { get; set; } = string.Empty;

        // Nowe pola wymagane przez frontend
        [Column(TypeName = "decimal(18,2)")]
        public decimal Price { get; set; } = 0.00m;

        public string Category { get; set; } = "Ogólny";

        public string Level { get; set; } = "Początkujący";

        public string ImageUrl { get; set; } = "/src/course/placeholder_ai.png";

        public string? InstructorId { get; set; }

        [ForeignKey("InstructorId")]
        public ApplicationUser? Instructor { get; set; }

        public ICollection<CourseSection> Sections { get; set; } = new List<CourseSection>();
        public ICollection<Enrollment> Enrollments { get; set; } = new List<Enrollment>();
    }
}

==================================================
FILE: ELearning.Api\ELearning.Api\Models\CourseContent\AnswerOption.cs
==================================================

namespace ELearning.Api.Models.CourseContent
{
    public class AnswerOption
    {
        public int Id { get; set; }
        public int QuestionId { get; set; }
        public string Text { get; set; }
        public bool IsCorrect { get; set; }

        public Question? Question { get; set; }
    }
}

==================================================
FILE: ELearning.Api\ELearning.Api\Models\CourseContent\Comment.cs
==================================================

using System;
using System.Collections.Generic;
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace ELearning.Api.Models.CourseContent
{
    public class Comment
    {
        [Key]
        public int Id { get; set; }

        [Required]
        public string Content { get; set; }

        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;

        public string UserId { get; set; }

        [ForeignKey("UserId")]
        public ApplicationUser User { get; set; }

        public int CourseId { get; set; }

        [ForeignKey("CourseId")]
        public Course Course { get; set; }

        public int? ParentCommentId { get; set; }

        [ForeignKey("ParentCommentId")]
        public Comment ParentComment { get; set; }

        public ICollection<Comment> Replies { get; set; } = new List<Comment>();
    }
}

==================================================
FILE: ELearning.Api\ELearning.Api\Models\CourseContent\CourseSection.cs
==================================================

namespace ELearning.Api.Models.CourseContent
{
    public class CourseSection
    {
        public int Id { get; set; }
        public int CourseId { get; set; }
        public string Title { get; set; } = string.Empty;
        public int Order { get; set; }


        public Course? Course { get; set; }
        public List<Lesson> Lessons { get; set; } = new List<Lesson>();
        public Quiz? Quiz { get; set; }
    }
}

==================================================
FILE: ELearning.Api\ELearning.Api\Models\CourseContent\Lesson.cs
==================================================

using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace ELearning.Api.Models.CourseContent
{
    public class Lesson
    {
        [Key]
        public int Id { get; set; }

        [Required]
        public string Title { get; set; } = string.Empty;

        public string Content { get; set; } = string.Empty;

        public string VideoUrl { get; set; } = string.Empty;

        public int SectionId { get; set; }

        
        [ForeignKey("SectionId")]
        public CourseSection? Section { get; set; }
    }
}

==================================================
FILE: ELearning.Api\ELearning.Api\Models\CourseContent\Question.cs
==================================================

namespace ELearning.Api.Models.CourseContent
{
    public class Question
    {
        public int Id { get; set; }
        public int QuizId { get; set; }
        public string Text { get; set; }
        public string QuestionType { get; set; } = "SingleChoice";

        public Quiz? Quiz { get; set; }
        public ICollection<AnswerOption> Options { get; set; } = new List<AnswerOption>();
    }
}

==================================================
FILE: ELearning.Api\ELearning.Api\Models\CourseContent\Quiz.cs
==================================================

using System.Collections.Generic;

namespace ELearning.Api.Models.CourseContent
{
    public class Quiz
    {
        public int Id { get; set; }
        public int SectionId { get; set; }
        public string Title { get; set; } = "Test z Sekcji";

        public CourseSection? Section { get; set; }
        public ICollection<Question> Questions { get; set; } = new List<Question>();
    }
}

==================================================
FILE: ELearning.Api\ELearning.Api\Models\Enrollment.cs
==================================================

using System;
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace ELearning.Api.Models
{
    public class Enrollment
    {
        [Key]
        public int Id { get; set; }

        [Required]
        public string UserId { get; set; } // To pole jest kluczowe!

        [ForeignKey("UserId")]
        public ApplicationUser User { get; set; }

        [Required]
        public int CourseId { get; set; }

        [ForeignKey("CourseId")]
        public Course Course { get; set; }

        public DateTime EnrollmentDate { get; set; } = DateTime.UtcNow;

        public int Progress { get; set; } = 0; // To pole te� musi by�

        public bool IsCompleted { get; set; } = false; // I to
    }
}

==================================================
FILE: ELearning.Api\ELearning.Api\Models\LessonCompletion.cs
==================================================

using System;
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;
using ELearning.Api.Models.CourseContent;

namespace ELearning.Api.Models
{
    public class LessonCompletion
    {
        [Key]
        public int Id { get; set; }

        [Required]
        public string UserId { get; set; }

        [ForeignKey("UserId")]
        public ApplicationUser User { get; set; }

        [Required]
        public int LessonId { get; set; }

        [ForeignKey("LessonId")]
        public Lesson Lesson { get; set; }

        public DateTime CompletedAt { get; set; } = DateTime.UtcNow;
    }
}

==================================================
FILE: ELearning.Api\ELearning.Api\Models\Notification.cs
==================================================

using System;
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace ELearning.Api.Models
{
    public class Notification
    {
        [Key]
        public int Id { get; set; }

        [Required]
        public string UserId { get; set; }

        [ForeignKey("UserId")]
        public ApplicationUser User { get; set; }

        [Required]
        public string Message { get; set; }

        public string Type { get; set; }

        public bool IsRead { get; set; } = false;

        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;

        public int? RelatedEntityId { get; set; }
    }
}

==================================================
FILE: ELearning.Api\ELearning.Api\Models\UserAnswer.cs
==================================================

namespace ELearning.Api.Models.CourseContent
{
    public class UserAnswer
    {
        public int Id { get; set; }
        public int AttemptId { get; set; }
        public int QuestionId { get; set; }
        public int AnswerOptionId { get; set; } // Wybrana opcja przez u�ytkownika
        public bool IsCorrect { get; set; } // Czy wybrana odpowied� by�a poprawna (obliczone w momencie zapisu)

        // Relacje
        public UserQuizAttempt? Attempt { get; set; }
        public Question? Question { get; set; }
        public AnswerOption? AnswerOption { get; set; }
    }
}

==================================================
FILE: ELearning.Api\ELearning.Api\Models\UserQuizAttempt.cs
==================================================

using ELearning.Api.Models;

namespace ELearning.Api.Models.CourseContent
{
    public class UserQuizAttempt
    {
        public int Id { get; set; }
        public int QuizId { get; set; }
        public string UserId { get; set; }
        public DateTime AttemptDate { get; set; } = DateTime.UtcNow;
        public int Score { get; set; }
        public int MaxScore { get; set; }
        public bool IsPassed { get; set; }

        // Relacje
        public Quiz? Quiz { get; set; }
        public ApplicationUser? User { get; set; }
        public ICollection<UserAnswer> UserAnswers { get; set; } = new List<UserAnswer>();
    }
}

==================================================
FILE: ELearning.Api\ELearning.Api\Program.cs
==================================================

using ELearning.Api.Models;
using ELearning.Api.Persistence;
using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.IdentityModel.Tokens;
using System.Text;
using ELearning.Api.Interfaces;
using ELearning.Api.Services;
using System.Text.Json.Serialization;
using QuestPDF.Infrastructure;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Http.Features; // DODANO: Potrzebne do FormOptions
using Microsoft.AspNetCore.StaticFiles;   // DODANO: Potrzebne do typ�w plik�w

var builder = WebApplication.CreateBuilder(args);

QuestPDF.Settings.License = LicenseType.Community;

// 1. KONFIGURACJA LIMIT�W PRZESY�ANIA PLIK�W (np. 200 MB)
builder.Services.Configure<FormOptions>(options =>
{
    options.MultipartBodyLengthLimit = 209715200; // 200 MB
});

builder.WebHost.ConfigureKestrel(serverOptions =>
{
    serverOptions.Limits.MaxRequestBodySize = 209715200; // 200 MB
});

builder.Services.AddControllers()
    .AddJsonOptions(options =>
    {
        options.JsonSerializerOptions.ReferenceHandler = ReferenceHandler.IgnoreCycles;
    });

builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

builder.Services.AddDbContext<ApplicationDbContext>(options =>
    options.UseSqlite(builder.Configuration.GetConnectionString("DefaultConnection")));

builder.Services.AddIdentity<ApplicationUser, IdentityRole>(options =>
{
    options.Password.RequireDigit = false;
    options.Password.RequireLowercase = false;
    options.Password.RequireUppercase = false;
    options.Password.RequireNonAlphanumeric = false;
    options.Password.RequiredLength = 4;
})
    .AddEntityFrameworkStores<ApplicationDbContext>()
    .AddDefaultTokenProviders();

builder.Services.AddScoped<IQuizService, QuizService>();
builder.Services.AddScoped<FileStorageService>();
builder.Services.AddScoped<CertificateService>();

// KONFIGURACJA CORS
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowAllDev",
        builder => builder
            .SetIsOriginAllowed(_ => true) // Pozwala na dowolny Origin (wymagane przy AllowCredentials)
            .AllowAnyMethod()
            .AllowAnyHeader()
            .AllowCredentials()); // Pozwala na wysy�anie ciasteczek/token�w auth
});

var jwtSettings = builder.Configuration.GetSection("JwtSettings");
var secretKey = jwtSettings["Secret"];
if (string.IsNullOrEmpty(secretKey))
{
    throw new Exception("JWT Secret is missing in appsettings.json");
}

var key = Encoding.UTF8.GetBytes(secretKey);

builder.Services.AddAuthentication(options =>
{
    options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
    options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
})
.AddJwtBearer(options =>
{
    options.RequireHttpsMetadata = false;
    options.SaveToken = true;
    options.TokenValidationParameters = new TokenValidationParameters
    {
        ValidateIssuer = true,
        ValidateAudience = true,
        ValidateLifetime = true,
        ValidateIssuerSigningKey = true,
        ValidIssuer = jwtSettings["Issuer"],
        ValidAudience = jwtSettings["Audience"],
        IssuerSigningKey = new SymmetricSecurityKey(key),
        ClockSkew = TimeSpan.Zero
    };
});

var app = builder.Build();

using (var scope = app.Services.CreateScope())
{
    var services = scope.ServiceProvider;
    try
    {
        var context = services.GetRequiredService<ApplicationDbContext>();
        context.Database.Migrate();
    }
    catch (Exception ex)
    {
        var logger = services.GetRequiredService<ILogger<Program>>();
        logger.LogError(ex, "An error occurred during migration or seeding the DB.");
    }
}

// 2. U�YCIE CORS - MUSI BY� PRZED UseStaticFiles i Auth
app.UseCors("AllowAllDev");

if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

// 3. KONFIGURACJA PLIK�W STATYCZNYCH Z OBS�UG� WIDEO
var contentTypeProvider = new FileExtensionContentTypeProvider();
contentTypeProvider.Mappings[".mp4"] = "video/mp4";
contentTypeProvider.Mappings[".mov"] = "video/quicktime";
contentTypeProvider.Mappings[".avi"] = "video/x-msvideo";
contentTypeProvider.Mappings[".pdf"] = "application/pdf";

app.UseStaticFiles(new StaticFileOptions
{
    ContentTypeProvider = contentTypeProvider,
    OnPrepareResponse = ctx =>
    {
        // Nag��wki dla odtwarzania wideo i pobierania plik�w
        ctx.Context.Response.Headers.Append("Access-Control-Allow-Origin", "*");
        ctx.Context.Response.Headers.Append("Access-Control-Allow-Headers", "Content-Type, Authorization, Range");
        ctx.Context.Response.Headers.Append("Access-Control-Expose-Headers", "Content-Range, Content-Length, Accept-Ranges");
    }
});

app.UseAuthentication();
app.UseAuthorization();

app.MapControllers();

app.Run();

==================================================
FILE: ELearning.Api\ELearning.Api\Services\CertificateService.cs
==================================================

using QuestPDF.Fluent;
using QuestPDF.Helpers;
using QuestPDF.Infrastructure;
using System;

namespace ELearning.Api.Services
{
    public class CertificateService
    {
        public byte[] GenerateCertificate(string studentName, string courseTitle, string instructorName, DateTime date)
        {
            var document = Document.Create(container =>
            {
                container.Page(page =>
                {
                    page.Size(PageSizes.A4.Landscape());
                    page.Margin(2, Unit.Centimetre);
                    page.PageColor(Colors.White);
                    page.DefaultTextStyle(x => x.FontSize(12));

                    page.Content()
                        .PaddingVertical(1, Unit.Centimetre)
                        .Column(x =>
                        {
                            x.Spacing(20);
                            x.Item().AlignCenter().Text("CERTYFIKAT UKO�CZENIA KURSU").SemiBold().FontSize(30).FontColor(Colors.Blue.Medium);
                            x.Item().AlignCenter().Text("Niniejszym za�wiadcza si�, �e").FontSize(18);
                            x.Item().AlignCenter().Text(studentName).Bold().FontSize(36).Underline();
                            x.Item().AlignCenter().Text("uko�czy�(a) z wynikiem pozytywnym kurs:").FontSize(18);
                            x.Item().AlignCenter().Text(courseTitle).Bold().FontSize(28).FontColor(Colors.Grey.Darken3);

                            x.Item().PaddingTop(30).Row(row =>
                            {
                                row.RelativeItem().Column(c =>
                                {
                                    c.Item().AlignCenter().Text(date.ToString("dd.MM.yyyy")).FontSize(14);
                                    c.Item().AlignCenter().Text("Data uko�czenia").FontSize(10).FontColor(Colors.Grey.Medium);
                                });

                                row.RelativeItem().Column(c =>
                                {
                                    c.Item().AlignCenter().Text(instructorName).FontSize(14);
                                    c.Item().AlignCenter().Text("Instruktor prowadz�cy").FontSize(10).FontColor(Colors.Grey.Medium);
                                });
                            });

                            x.Item().PaddingTop(50).AlignCenter().Text("ELearning Platform").FontSize(10).FontColor(Colors.Grey.Lighten1);
                        });
                });
            });

            return document.GeneratePdf();
        }
    }
}

==================================================
FILE: ELearning.Api\ELearning.Api\Services\FileStorageService.cs
==================================================

using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Http;
using System;
using System.IO;
using System.Threading.Tasks;

namespace ELearning.Api.Services
{
    public class FileStorageService
    {
        private readonly IWebHostEnvironment _environment;

        public FileStorageService(IWebHostEnvironment environment)
        {
            _environment = environment;
        }

        public async Task<string> SaveFileAsync(IFormFile file)
        {
            if (file == null || file.Length == 0)
            {
                throw new ArgumentException("Plik jest pusty lub nie istnieje.");
            }

            // POPRAWKA: Zabezpieczenie na wypadek gdyby WebRootPath by� null (co zdarza si� w API)
            string webRootPath = _environment.WebRootPath ?? Path.Combine(_environment.ContentRootPath, "wwwroot");

            string uploadsFolder = Path.Combine(webRootPath, "uploads");
            if (!Directory.Exists(uploadsFolder))
            {
                Directory.CreateDirectory(uploadsFolder);
            }

            string uniqueFileName = Guid.NewGuid().ToString() + Path.GetExtension(file.FileName);
            string filePath = Path.Combine(uploadsFolder, uniqueFileName);

            using (var fileStream = new FileStream(filePath, FileMode.Create))
            {
                await file.CopyToAsync(fileStream);
            }

            return $"/uploads/{uniqueFileName}";
        }
    }
}

==================================================
FILE: ELearning.Api\ELearning.Api\Services\QuizService.cs
==================================================

using ELearning.Api.DTOs.Quiz;
using ELearning.Api.Interfaces;
using ELearning.Api.Persistence;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;
using ELearning.Api.Models.CourseContent;

namespace ELearning.Api.Services
{
    public class QuizService : IQuizService
    {
        private readonly ApplicationDbContext _context;

        public QuizService(ApplicationDbContext context)
        {
            _context = context;
        }

        public async Task<QuizQuestionsDto?> GetQuizByIdAsync(int quizId, string userId)
        {
            // �adujemy quiz z jego pytaniami i opcjami
            var quiz = await _context.Quizzes
                .Where(q => q.Id == quizId)
                .Include(q => q.Questions)
                    .ThenInclude(qs => qs.Options)
                .Select(q => new QuizQuestionsDto
                {
                    // Mapowanie na DTO. Zapewniamy, �e nazwy p�l DTO s� u�ywane (np. QuestionId)
                    QuizId = q.Id,
                    Title = q.Title,
                    SectionId = q.SectionId,
                    Questions = q.Questions.Select(qs => new QuestionDto
                    {
                        QuestionId = qs.Id,
                        Text = qs.Text,
                        QuestionType = qs.QuestionType,
                        Options = qs.Options.Select(o => new AnswerOptionDto
                        {
                            AnswerOptionId = o.Id,
                            Text = o.Text
                        }).ToList()
                    }).ToList()
                })
                .FirstOrDefaultAsync();

            return quiz;
        }

        public async Task<QuizResultDto> SubmitQuizAsync(SubmitQuizDto submitDto, string userId)
        {
            var quizId = submitDto.QuizId;

            // 1. Pobranie poprawnych odpowiedzi dla quizu
            // U�ywamy z��czenia implicite poprzez Question, aby upewni� si�, �e pobieramy tylko dla danego quizu
            var correctAnswers = await _context.AnswerOptions
                .Where(o => o.Question.QuizId == quizId && o.IsCorrect)
                .ToDictionaryAsync(o => o.QuestionId, o => o.Id);

            int score = 0;
            int maxScore = correctAnswers.Count;

            var userAttempt = new Models.CourseContent.UserQuizAttempt
            {
                QuizId = quizId,
                UserId = userId,
                MaxScore = maxScore
            };

            // 2. Por�wnanie odpowiedzi i obliczenie wyniku
            foreach (var submittedAnswer in submitDto.Answers)
            {
                // Musimy upewni� si�, �e submittedAnswer.QuestionId istnieje w correctAnswers
                var isCorrect = correctAnswers.TryGetValue(submittedAnswer.QuestionId, out var correctOptionId) && correctOptionId == submittedAnswer.AnswerOptionId;

                userAttempt.UserAnswers.Add(new Models.CourseContent.UserAnswer
                {
                    QuestionId = submittedAnswer.QuestionId,
                    AnswerOptionId = submittedAnswer.AnswerOptionId,
                    IsCorrect = isCorrect
                });

                if (isCorrect)
                {
                    score++;
                }
            }

            userAttempt.Score = score;

            // Za�o�enie: zaliczony przy 80% poprawnych odpowiedzi
            userAttempt.IsPassed = maxScore > 0 && (double)score / maxScore >= 0.8;

            // 3. Zapisanie pr�by
            _context.UserQuizAttempts.Add(userAttempt);
            await _context.SaveChangesAsync();

            // 4. Pobranie liczby pr�b
            var attemptsCount = await _context.UserQuizAttempts
                .CountAsync(a => a.QuizId == quizId && a.UserId == userId);

            // 5. Zwr�cenie wyniku
            return new QuizResultDto
            {
                Score = score,
                MaxScore = maxScore,
                IsPassed = userAttempt.IsPassed,
                AttemptsCount = attemptsCount
            };
        }
    }
}
